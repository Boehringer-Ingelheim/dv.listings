<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Data review (experimental feature) • dv.listings</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data review (experimental feature)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="inverse" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dv.listings</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">4.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Communication_jumping_feature.html">Communication with DaVinci modules</a></li>
    <li><a class="dropdown-item" href="../articles/data_review.html">Data review (experimental feature)</a></li>
    <li><a class="dropdown-item" href="../articles/qc.html">Quality Control</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/qc.html">Quality Control</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Data review (experimental feature)</h1>
            
      

      <div class="d-none name"><code>data_review.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>dv.listings</code> module provides an optional user
interface to assist data review processes. It enables a team of
reviewers to annotate each row of a given listing with a tag chosen from
a preconfigured list of options. In addition, it keeps track of changes
to the data underlying the listings to warn about possibly outdated
reviews.</p>
<p>Please note that <strong>this feature is still experimental and may
be subject to change</strong>. Also note that, at the moment,
<strong>only one instance of the <code>dv.listings</code> module can
provide this feature on any given DaVinci app</strong>.</p>
<p>Here’s a more detailed description of the review function:</p>
<ul>
<li>Users can self-select a reviewer role and, under that capacity,
annotate each row of any given dataset with a value chosen from those
available on a dropdown menu.</li>
<li>Several users can interact under <em>strictly non-overlapping</em>
roles with the application, each annotating individual rows of
<em>possibly overlapping</em> datasets.</li>
<li>All decisions, including conflicting ones (i.e., those differing
across roles), are stored. The last decision is the one visible to all
users by default.</li>
<li>Rows are identified by a subset of the dataset’s columns (which we
call <code>identifier</code> columns). That subset is dataset-specific.
No two rows can share the same set of identifier values.</li>
<li>A subset of the columns (which we call <code>tracked</code> and does
not overlap the <code>identifier</code> columns) is considered necessary
and sufficient for review purposes.</li>
<li>Updates to the provided datasets are expected during the course of a
study.</li>
<li>Changes to contents of <code>tracked</code> columns of a previously
reviewed dataset row will be highlighted in the user interface and
require re-confirmation.</li>
<li>All datasets share the same decision dropdown choices.</li>
</ul>
</div>
<div class="section level2">
<h2 id="user-interface">User interface<a class="anchor" aria-label="anchor" href="#user-interface"></a>
</h2>
<div class="section level3">
<h3 id="structure">Structure<a class="anchor" aria-label="anchor" href="#structure"></a>
</h3>
<p>When properly configured, the interface of the module expands to show
three extra components, as pictured below:</p>
<ul>
<li>A drop-down menu (top-right corner) that allows users to select:
<ol style="list-style-type: decimal">
<li>A location to store information derived from the review
process.</li>
<li>A reviewer role under which actions will be registered.</li>
</ol>
</li>
<li>Additional columns to the left of the listing (bottom-left corner)
to perform point-and-click reviews:
<ol start="3" style="list-style-type: decimal">
<li>The “latest review” column shows the most recent review provided by
a member of the team and allows to change it.</li>
<li>The “status” column displays possible review disagreements among the
team and allows to investigate and resolve them.</li>
</ol>
</li>
<li>A “bulk review” menu (top-left) that allows users to:
<ol start="5" style="list-style-type: decimal">
<li>Select a new review decision.</li>
<li>Apply it to:
<ul>
<li>Rows individually selected through the left-most per-row checkboxes
(through the “Apply selected” button).</li>
<li>All rows in the output, including on subsequent pages (through the
“Apply full table”). This selection is affected by the column
filters.</li>
</ul>
</li>
</ol>
</li>
</ul>
<p><img src="images/review00.jpg"></p>
<p>These three review columns behave similarly to the regular listing
columns, as they allow filtering and sorting. Thus, they make it easy to
find which reviews are pending or to list reviews that conflict across
reviewers.</p>
</div>
<div class="section level3">
<h3 id="highlighting-of-potentially-outdated-reviews">Highlighting of potentially outdated reviews<a class="anchor" aria-label="anchor" href="#highlighting-of-potentially-outdated-reviews"></a>
</h3>
<p>As a study progresses, it is possible for data that has already been
reviewed to change. In order to bring those changes to the attention of
reviewers, <code>dv.listings</code> automatically highlights altered
data cells (on columns specified as <code>tracked</code>) that may make
previous reviews outdated.</p>
<p>In case there are more than four altered cells on a given row, the
whole row is highlighted as outdated.</p>
<p>In the picture below, you can see that the “Severity” of the first
adverse event has changed.</p>
<p><img src="images/review01.jpg"></p>
<p>The user can isolate all reviewed, and later altered, rows by
selecting “Latest Outdated” on the “Status” column. These rows will be
cleared of the orange highlighting once a reviewer confirms them as
still correct or re-reviews them otherwise.</p>
</div>
</div>
<div class="section level2">
<h2 id="module-configuration">Module configuration<a class="anchor" aria-label="anchor" href="#module-configuration"></a>
</h2>
<p>The review feature is configured through the optional
<code>review</code> parameter of <code>mod_listings</code>. Below is an
example configuration for two hypothetical demographics
(<code>dm</code>) and adverse events (<code>ae</code>) SDTM domains:</p>
<pre><code><span><span class="fu"><a href="../reference/mod_listings.html">mod_listings</a></span><span class="op">(</span></span>
<span>  <span class="va">...</span>, <span class="co"># all other parameters omitted for brevity</span></span>
<span>  dataset_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ae"</span>, <span class="st">"dm"</span><span class="op">)</span>,</span>
<span>  review <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    datasets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      dm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        id_vars <span class="op">=</span> <span class="st">"USUBJID"</span>,</span>
<span>        tracked_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"DMDTC"</span>, <span class="st">"RFSTDTC"</span>, <span class="st">"RFENDTC"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      ae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        id_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"USUBJID"</span>, <span class="st">"AESEQ"</span><span class="op">)</span>, </span>
<span>        tracked_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"AETERM"</span>, <span class="st">"AEDECOD"</span>, <span class="st">"AESEV"</span>, <span class="st">"AESTDTC"</span>, </span>
<span>          <span class="st">"AEENDTC"</span>, <span class="st">"AEOUT"</span>, <span class="st">"AEACN"</span>, <span class="st">"AEREL"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    choices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Pending"</span>, <span class="st">"Action required"</span>, <span class="st">"Reviewed"</span><span class="op">)</span>,</span>
<span>    roles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TSTAT"</span>, <span class="st">"SP"</span>, <span class="st">"Safety"</span>, <span class="st">"CTL"</span><span class="op">)</span>,</span>
<span>    store_path <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<p>The <code>review</code> parameter is itself divided into four
subfields:</p>
<ul>
<li>
<p><code>datasets</code>: A named list of domain configurations. The
names refer to datasets with associated listings, i.e. those provided
through the <code>dataset_names</code> parameter. Each of the elements
in that list is itself a list with two elements:</p>
<ul>
<li>
<code>id_vars</code>: <code>[character(n)]</code> Immutable
variables that uniquely identify each record for a given domain. For
example, in the case of the demographics domain, the
<strong>U</strong>nique <strong>SUBJ</strong>ect
<strong>ID</strong>entifier is enough. In the case of the adverse events
domain, both USUBJID and the <strong>A</strong>dverse
<strong>E</strong>vent <strong>SEQ</strong>uence number are
necessary.</li>
<li>
<code>tracked_vars</code>: <code>[character(3+)]</code> Variables to
track across dataset updates. If the contents of one of this columns
changes on an already reviewed row, that review will be marked as
potentially outdated. This vector should list at least three
variables.</li>
</ul>
</li>
<li><p><code>choices</code>: <code>[character(n)]</code> Review choices
available to assign to each listing row.</p></li>
<li><p><code>roles</code>: <code>[character(n)]</code> Names of reviewer
roles. These names can only include the following characters:
alphanumerical, space, dot, underscore and dash.</p></li>
<li><p><code>store_path</code>: <code>[character(1)]</code> Optional. If
specified, files associated to the review process will be stored on this
path on the server. If left unspecified, those files will be stored on a
folder of the <em>client</em>’s computer. The users of the app will have
the opportunity to choose the path when they launch it.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="storage-of-review-related-files">Storage of review-related files<a class="anchor" aria-label="anchor" href="#storage-of-review-related-files"></a>
</h2>
<p>The review of datasets that evolve over the course of a clinical
trial requires some form of storage that is:</p>
<ul>
<li>Shared among the members of the team conducting the review.</li>
<li>Stable throughout the duration of the trial.</li>
</ul>
<p>The natural location for this storage would be on a folder of the
server that hosts the review application. However, some Shiny execution
environments lack permanent server storage. In such cases, the module
offers the possibility of storing review information on the client side
if the <code>store_path</code> field of the <code>review</code>
parameter is left unspecified.</p>
<div class="section level4">
<h4 id="client-side-storage">Client side storage<a class="anchor" aria-label="anchor" href="#client-side-storage"></a>
</h4>
<p>Recent versions of Google Chrome and browsers derived from it (Edge,
etc.) offer experimental support for javascript code to read and write
to the client file system as native apps do. This module takes advantage
of this <a href="https://wicg.github.io/file-system-access/" class="external-link">File System
Access API</a> to compensate for the potential lack of server
storage.</p>
<p>In practical terms, relying on this feature means that every time
users access a review app, their browser will prompt them to ask for
permission to read and write to a folder allocated specifically for
review purposes.</p>
<p>In the case of reviews conducted by a team of reviewers, the team as
a whole will have to decide beforehand which networked folder (shared
through NFS, Google Drive, Microsoft OneDrive, Dropbox, …) to use in
order to collaborate for the duration of the study.</p>
<p>We recommend that users participating in multiple studies set up an
independent folder for each of them.</p>
</div>
</div>
<div class="section level2">
<h2 id="data-stability-requirements">Data Stability Requirements<a class="anchor" aria-label="anchor" href="#data-stability-requirements"></a>
</h2>
<p>The module only has access to the latest version of any given
dataset. In order to inform users about modified and newly added
records, it relies on stored summary hashes of previously seen data.
Thus, it’s necessary that some aspects of the representation of data are
kept constant over the life of a study. These are:</p>
<ul>
<li>All rows of each provided dataset are identified uniquely by the
combination of <code>id_vars</code> configured at the beginning of the
study.</li>
<li>Identifying variables (defined through <code>id_vars</code>) and
tracked variables (defined through <code>tracked_vars</code>) have to
remain the same for the duration of the study.</li>
<li>Identifying and tracked variables retain their types (factor,
numeric, …) and are available on each revision of each dataset.</li>
</ul>
</div>
<div class="section level2">
<h2 id="implementation-details">Implementation details<a class="anchor" aria-label="anchor" href="#implementation-details"></a>
</h2>
<p>This final section documents the design principles and the structure
of the review-related files that <code>dv.listings</code> creates. It
can be safely skipped for regular use of the review feature. However it
may prove useful in the following scenarios:</p>
<ul>
<li>For future <code>dv.listings</code> developers/maintainers, to know
the reasoning behind some unusual design decisions.</li>
<li>For app creators and users, to know how to backup and migrate review
data.</li>
<li>For app users, to know how to read and explore review data outside
the limitations of the module.</li>
</ul>
<p>The file formats used for the review portion of
<code>dv.listings</code> are still a work in progress, but our goal is
to document them thoroughly enough for external tools to parse them or
even produce them. This should allow third-parties to address specific
user needs without cluttering the <code>dv.listings</code> module with
infrequently used (but still useful) functionality.</p>
<details><summary><strong>Storage design considerations</strong>
</summary><p>The nature of the review feature requires concurrent multi-user
(multi-session, multi-process) write access to a shared resource, which
Posit deems incompatible with pins (<a href="https://docs.posit.co/connect/user/pins/" class="external-link uri">https://docs.posit.co/connect/user/pins/</a>, see reddish
box).</p>
<p>This is the first DaVinci module that stores permanently a
substantial amount of study decisions taken over an extended period of
time. Loss of data in this context is not acceptable. To guarantee data
integrity, we propose the use of simple <em>append-only</em> data
structures. Those are stored as plain files opened in “append” mode.
It’s easy to demonstrate that they can’t become the source of
catastrophic loss of data of past review sessions. The granularity of
the <code>pins</code> API (which only allows to load and store complete
files) is incompatible with this design.</p>
<p>Data appending improves performance, as only new changes need to be
serialized. It’s also useful for version tracking, as all editing
operations can be replayed in the order in which they happened.</p>
<p>Backing up review data can be accomplished by copying the contents of
the container folder to an independent file system. Since all review
operations are appended, a delta-transmission tool such as
<code>rsync</code> is a natural fit.</p>
<p>Lastly, using plain file storage allows for easy local testing and
for universal use of the review feature (running the application
locally, on Connect, on Openshift, …).</p>
</details><details><summary><strong>Structure of stored files</strong>
</summary><p>If we take a hypothetical “xyz” domain, <code>dv.listings</code> will
store the following files for review purposes (expand to see the layout
of their contents):</p>
<details><summary><code>xyz_000.base</code> (information related to the first version of
the “xyz” domain dataset seen by the module)
</summary><ul>
<li>1 file magic code (“LISTBASE”)</li>
<li>1 format version number (0)</li>
<li>1 generation marker (0)</li>
<li>1 timestamp of creation date+time (UTC)</li>
<li>1 complete hash of the “xyz” data.frame</li>
<li>1 domain string (“xyz”)</li>
<li>n <code>id_vars</code> variable names</li>
<li>n <code>id_vars</code> variable types (see “Variable type encoding”
below)</li>
<li>m <code>tracked_vars</code> variable names</li>
<li>m <code>tracked_vars</code> variable types (see “Variable type
encoding” below)</li>
<li>1 row count</li>
<li>p (1 per “xyz” row) <code>hash_id(xyz[id_vars])</code>
</li>
<li>p (1 per “xyz” row, 2*m bytes long)
<code>hash_tracked(xyz[tracked_vars])</code>
</li>
</ul></details><details><summary><code>xyz_001.delta</code> (one per domain dataset update)
</summary><ul>
<li>1 file magic code (“LISTDELT”)</li>
<li>1 format version number (0)</li>
<li>1 generation marker (1). Wraps around to 0 after 255 (e.g. for
<code>xyz_256.delta</code>)</li>
<li>1 timestamp delta (seconds elapsed since “base” timestamp)</li>
<li>1 complete hash of new “xyz” data.frame</li>
<li>1 domain string (“xyz”)</li>
<li>1 count of new rows</li>
<li>n (1 per <em>new</em> “xyz” row)
<code>hash_id(xyz[id_vars])</code>
</li>
<li>n (1 per <em>new</em> “xyz” row, 2*m bytes long)
<code>hash_tracked(xyz[tracked_vars])</code>
</li>
<li>1 count of modified rows</li>
<li>p (1 per <em>modified</em> “xyz” row) row index</li>
<li>p (1 per <em>modified</em> “xyz” row, 2*m bytes long)
<code>hash_tracked(xyz[tracked_vars])</code>
</li>
</ul></details><details><summary><code>xyz_&lt;ROLE&gt;.review</code> (one per domain and ROLE)
</summary><ul>
<li>1 file magic code (“LISTREVI”)</li>
<li>1 format version number (0)</li>
<li>1 role string</li>
<li>1 domain string (“xyz”)</li>
<li>n reviews: row index + <code>review_index</code> + delta
timestamp</li>
</ul></details><details><summary><code>review.codes</code> (one per app):
</summary><ul>
<li>1 file magic code (“LISTCODE”)</li>
<li>1 format version number (0)</li>
<li>n review texts</li>
</ul></details><p>(Row indices refer to indices in the stored base+delta matrix, which
is append-only. These <em>canonical</em> indices are as good as
identifiers).</p>
<p>The dominant factor governing the size of these files is the length
of a hash, which is 16 bytes in the case of <code>hash_id</code> and 2*m
bytes (m being the number of tracked columns) in the case of
<code>hash_tracked</code>, as we discuss in the “Hashing” session below.
Row indices and delta timestamps can be encoded in 4 bytes. Review
indices take up 1 byte each. Estimating an upper bound of 1 million rows
per dataset, a <code>.base</code> file tracking 8 variables would take
around 32 MiB. A comprehensive <code>.review</code> file for such a
dataset would take around 9 MiB.</p>
<p>These file structures are designed so that they start with a short
heterogeneous header that reiterates the information that can be gleaned
from the file name. The rest of the records are all homogeneous and of
known size. That allows to load them into memory without the need for
expensive parsing.</p>
<p>These files won’t benefit much from compression since their main
content (the hashes) is by construction statistically indistinguishable
from noise.</p>
</details><details><summary><strong>Variable type encoding</strong>
</summary><p>The two “variable type” <code>.base</code> fields are encoded as
single bytes that take the following values:</p>
<ul>
<li>Date: 1</li>
<li>POSIXct: 2</li>
<li>POSIXlt: 3</li>
<li>Logical: 10</li>
<li>Factor: 11</li>
<li>Integer: 13</li>
<li>Numeric: 14</li>
<li>Complex: 15</li>
<li>Character: 16</li>
<li>Raw: 24</li>
</ul>
<p>Most of these values are taken from the base R <code>SEXPTYPE</code>
enum definition (see <code>src/include/Rinternals.h</code> on any recent
R source distribution).</p>
<p>The values assigned to time types are arbitrary, because they are S3
objects and thus lack dedicated <code>SEXPTYPE</code> values.</p>
The type of a <code><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor()</a></code> variable is not fully defined by it
being tagged as such, since the levels and their internal encoding is
also part of the type. For purposes of hashing, the review feature of
<code>dv.listings</code> treats the content of factor columns as
<code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code> by mapping their value to their assign
string-like representation. This feature also is indifferent to a factor
being ordered.
</details><details><summary><strong>Hashing strategy</strong>
</summary><p>We store hashes for the values of <code>id_vars</code> and
<code>tracked_vars</code> dataset columns. These hashes serve as content
IDs.</p>
<div class="section level4">
<h4 id="choice-of-hash-function">Choice of hash function<a class="anchor" aria-label="anchor" href="#choice-of-hash-function"></a>
</h4>
<p>A popular choice for non-cryptographic hashing is the
<code>xxh</code> family of function (<a href="https://github.com/Cyan4973/xxHash/tree/dev?tab=readme-ov-file#xxhash---extremely-fast-hash-algorithm" class="external-link uri">https://github.com/Cyan4973/xxHash/tree/dev?tab=readme-ov-file#xxhash---extremely-fast-hash-algorithm</a>)
for its balance of speed and perceived hash quality. Three independent R
packages implement them:</p>
<ul>
<li>rlang: Provides no control over serialization, so hashes are
potentially not stable across R versions.</li>
<li>digest: Maintained by Dirk Eddelbuettel, known for being a stickler
for backwards compatibility. Provides serialization options.</li>
<li>xxhashlite: Substantially faster than the other two implementations
for small input sizes (our scenario). Provides serialization
options.</li>
</ul>
<p>It makes sense to use the fastest implementation available, as it
respects the time of users and requires less energy.
<code>xxhashlite</code> is then the clear winner, but migration to
<code>digest</code> (or “vendoring” of <code>xxhashlite</code> inside
this package) is always possible if this lesser-known package is somehow
retired from CRAN.</p>
</div>
<div class="section level4">
<h4 id="hashing-of-id-variables-hash_id">Hashing of ID variables (<code>hash_id()</code>)<a class="anchor" aria-label="anchor" href="#hashing-of-id-variables-hash_id"></a>
</h4>
<p>With a perfect hash function, we would expect a collision after
<code>2^(n/2)</code> entries have been hashed, where <code>n</code> is
the output length in bits of the chosen hash. A hash that produces 64
bits is not strong enough as 2^32 is a large quantity of hashes, but
still bound to collide if the review feature is used long enough.</p>
<p>We opt instead for 128 bits, which makes the possibility of a
collision extremely unlikely. We expect an upper bound of one million
rows per dataset, which is 13 <em>orders of magnitude</em> lower than
the mean amount of entries estimated necessary to get a collision. The
chosen hash won’t be perfect, but we have an ample safety margin. We
also assume that data has not been created through adversarial means
geared towards making hash collisions more likely.</p>
</div>
<div class="section level4">
<h4 id="hashing-of-tracked-variables-hash_tracked">Hashing of tracked variables (<code>hash_tracked()</code>)<a class="anchor" aria-label="anchor" href="#hashing-of-tracked-variables-hash_tracked"></a>
</h4>
<p>We could apply the same reasoning behind the choice of the
<code>hash_id()</code> function to the hashing of the variable parts of
each row. We instead propose a more complex hashing scheme to provide
partial information about <em>which variables of a row have been
altered</em> when its hash changes.</p>
<p>Each hash value is 2*m bytes long, where <em>m</em> is the number of
variables tracked of a given dataset. Each of those bytes is an
independent hash of three of the tracked variables of a dataset row.
Each variable, in turn, contributes to three of the 2*m byte-sized
hashes. This mixing of variables makes it harder for an external
adversarial observer of the <code>.base</code> and <code>.delta</code>
files to brute-force the original values of the dataset by looking for
collisions with the computed hash values.</p>
<p>To compute which variables contribute to which hash byte pair, we use
the following scheme:</p>
<ul>
<li>Byte pair <em>n</em>: Variables (<em>n</em>+0)%<em>n</em>,
(<em>n</em>+2)%<em>n</em> and (<em>n</em>+3)%<em>n</em>
</li>
</ul>
<p>Where <code>%</code> indicates the remainder of the integer
division.</p>
<p>So, for a input dataset with seven tracked variables (zero through
six), this would mean:</p>
<ul>
<li>Byte pair 0: Variables 0, 2 and 3</li>
<li>Byte pair 1: Variables 1, 3 and 4</li>
<li>Byte pair 2: Variables 2, 4 and 5</li>
<li>Byte pair 3: Variables 3, 5 and 6</li>
<li>Byte pair 4: Variables 4, 6 and 0</li>
<li>Byte pair 5: Variables 5, 0 and 1</li>
<li>Byte pair 6: Variables 6, 1 and 2</li>
</ul>
<p>This scheme creates unique mixtures of variables. Take, for instance,
variable 0. It is combined with variables 2 and 3 on the zeroth byte
pair, with variables 4 and 6 on the fourth byte pair and with 1 and 5
for the fifth byte pair.</p>
<p>Each of these byte pairs is computed by:</p>
<ul>
<li>Taking the three values to hash.</li>
<li>Serializing them to text and concatenating them using the non-ASCII
byte separator <code>1D</code> (also known as “group separator”).</li>
<li>Computing the <code>xxh32</code> hash and returning its two most
significant bytes.</li>
</ul>
<p>Informal testing (refer to
<code>tests/testthat/tests-hash_tracked.R</code> for more details) of
this hashing scheme shows the following properties:</p>
<ul>
<li>It’s capable of identifying up to four modified variables per row
(after that, it’s preferable to give up and notify the whole row as
modified).</li>
<li>It has a very low <strong>false negative rate</strong> (a variable
is modified without it being notified as such).</li>
<li>It has a low <strong>false positive rate</strong> (a variable that
retains its value is notified as modified). This only happens when there
are actual changes to a row.</li>
</ul>
<p>False positives are not critical, as they ask reviewers to consider a
larger set of variables when re-reviewing a row that has been
altered.</p>
<p>False negatives <em>are</em> critical, since they allow changes to go
unreported to reviewers. This is why our choice of hash favors false
positives over false negatives.</p>
<p>This composite hash function is a compromise found through heuristic
exploration. If we come up with a better option, we can version it
through the “format version number” present in <code>.base</code> and
<code>.delta</code> files. This means that neither app creator nor app
users have to concern themselves about the underlying
<code>hash_tracked</code> representation.</p>

</div>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Boehringer-Ingelheim Pharma GmbH &amp; Co.KG, Isabel Glauss, Korbinian Matthias, Luis Morís Fernández.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
